{% extends 'base.html' %}

{% block content %}

<h3>Snearch Summary:</h3>

{% for term in search_terms %}
<li>{{ term }} ( {{ curr_search_dict[term]['count'] }} results)</li>
{% endfor %}

<p>Total search results: {{ result_sum }}</p>

<h3>Snearch Results:</h3>

<div id=snearch_results_div>

<p>You found this shirt by searching: 
    '<label id="user_search_term"><strong>User search term placeholder</strong></label>'</p>
        <img id="image" src="http://i.imgur.com/ly4VZeN.gif">
        <li id="price">PRICE</li>
        <li><a id="link" href="http://http://www.kittenwar.com/">Shirt Link</a></li>
        <input type="button" id="next" value="Next Shirt, Please!"></button>

</div><br><br>

{{ curr_search_dict.keys() }}

<script type="text/javascript">

    var currSearchDict = {{ curr_search_dict|tojson }};
    var allSearchTerms = Object.keys(currSearchDict);

    var nonZeroSearchTerms = [];
    function addSearchTerms(allSearchTerms) {
        for (var i = 0; i < allSearchTerms.length; i++) {
            if (currSearchDict[allSearchTerms[i]]['count'] !== 0) {
                nonZeroSearchTerms.push(allSearchTerms[i]);
            }
        }
    }
    addSearchTerms(allSearchTerms);

    var currSearchTerm;
    function termCycle() {
        // Cycle through the nonZeroSearchTerms to get the next currSearchTerm
        if (currSearchTerm == undefined) {
            currSearchTerm = nonZeroSearchTerms[0];
            return currSearchTerm;
        }
        else {
            var index = nonZeroSearchTerms.indexOf(currSearchTerm);
            if (index == nonZeroSearchTerms.length - 1) {
                index = -1;
            }
            currSearchTerm = nonZeroSearchTerms[index + 1];
            return currSearchTerm;
        }
    }

    function getAShirt() {
        currSearchTerm = termCycle();
        console.log("getAShirt term: ", currSearchTerm);
        var currShirt = currSearchDict[currSearchTerm]['items'].pop();
        currSearchDict[currSearchTerm]['countdown'] -= 1;
        console.log("shirt countdown: ", currSearchDict[currSearchTerm]['countdown']);
        // LATER: If shirt count is low, make AJAX request to get more from the Etsy API
        return currShirt;
    }

    function displayNewShirt(shirt_object) {
        var shirt_url = shirt_object['url'];
        var shirt_price = shirt_object['price'];
        var shirt_image_url = shirt_object['image_url'];
        var user_search_term = shirt_object['user_search_term'];

        $('#image').attr('src', shirt_image_url);
        $('#price').html(shirt_price);
        $('#link').attr('href', shirt_url);
        $('#user_search_term').html(user_search_term);
    }

    $(document).ready(function() {
        displayNewShirt(getAShirt());
        });
    $('#next').on('click', function(evt) {
        displayNewShirt(getAShirt());
    });

</script>


{% endblock %}



<!-- ********** DEAD CODE: **********

{% for term in search_terms %}
<li>{{ term }} ({{ session.curr_search[term]['count'] }} results)</li>
{% endfor %}

<p>Total search results: {{ session.result_count }}</p>

<h3>Snearch Results:</h3>

<div id=snearch_results_div>

<p>You found this shirt by searching: '<label id="user_search_term"><strong>User search term placeholder</strong></label>'</p>
    <img id="image" src="http://i.imgur.com/ly4VZeN.gif">
    <li id="price">PRICE</li>
    <li><a id="link" href="http://stackoverflow.com/questions/179713/how-to-change-the-href-for-a-hyperlink-using-jquery">Shirt Link</a></li>
    <input type="button" id="next" value="Next Shirt, Please!"></button>

</div><br><br>

<script type="text/javascript">

    function displayNewShirt(results) {
        var shirt_url = results.shirt_url;
        var shirt_price = results.shirt_price;
        var shirt_image_url = results.shirt_image_url;
        var user_search_term = results.user_search_term;

        $('#image').attr('src', shirt_image_url);
        $('#price').html(shirt_price);
        $('#link').attr('href', shirt_url);
        $('#user_search_term').html(user_search_term);
    }

    function requestNewShirt(evt) {
        $.post("/new_shirt_please", displayNewShirt);

        console.dir(evt)
    }
    
    $('#next').on('click', requestNewShirt);

    $(document).ready(function() {
        $.get("/shnerdy_scale_set", function(results) {
            console.log(results);
            $.post("/new_shirt_please", displayNewShirt);
        });
        
    });

</script>

Current Search Terms: {% for term in session['curr_search'].keys() %}
<li>Term: {{ term }}, Countdown: {{ session['curr_search'][term]['countdown'] }}</li>
{% endfor %} -->