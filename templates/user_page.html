{% extends 'base.html' %}

{% block content %}

<script type="text/javascript">$('#user_page_link').hide();</script>

<h1>Search Shnerdy!</h1><br>

<div class="row">
    <div class="col-xs-6"><h4>Search for shirts...</h4>
        
        {% if categories == [] %}
            <div id="if_cat-empty">
                <p>Looks like you haven't created any searches yet. Add some here!</p>
            </div>

            <div id="snearch_div_hide" hidden>
                <form action="/listy" id="snearch_form" method="POST">
                    <select id="category_dropdown" name="categories">
                        <option name="cat_drop_opt" value="cat_name">Please Select...</option>
                    </select>
                        <input type="hidden" id="user_id_drop" name="user_id" value="{{ user.id }}">
                        <input type="submit" id="snearch_submit" name="search_shirts" value="Select Search Category">
                </form><br><br>
            </div>
        {% endif %}

        {% if categories != [] %}
            <div id="snearch_div">
                <form action="/listy" id="snearch_form" method="POST">
                    <select id="category_dropdown" name="categories">
                        <option name="cat_drop_opt" value="cat_name">Please Select...</option>
                    </select>
                        <input type="hidden" id="user_id_drop" name="user_id" value="{{ user.id }}">
                        <input type="submit" id="snearch_submit" name="search_shirts" value="Select Search Category">
                </form><br><br>
            </div>
        {% endif %}  
        
    </div>

    <script type="text/javascript">

        function updateDropdown(results) {
            $('#category_dropdown').empty();
            var insertHtml = "";
            var cat_list = results.cat_list;
            for (i = 0; i < cat_list.length; i++) {
                var list_item = "'" + cat_list[i] + "'";
                insertHtml += '<option name="cat_drop_opt" value=' + list_item + '>' + cat_list[i] + '</option>'
            };
            $('#category_dropdown').append(insertHtml);
        }

        function updateDropdownRequest(evt) {
            var userId = {'user_id' : $('#user_id_drop').val()};

            $.post("/update_dropdown",
                userId,
                updateDropdown);

            console.dir(evt)
        }

        $('#category_dropdown').on('click', updateDropdownRequest);

    </script>

    <div class="col-xs-6"><h4>...or add a new category to search!</h4>
        <form action='/add_category' id="cat_add_form" method="POST">
            Category Name: <input type="text" id="new_category_box" name="category">
            <input type="hidden" id="user_id_category" name="user_id" value="{{ user.id }}">
            <input type="submit" id="category_add" value="Add Category">
        </form><br><br>
    </div>
</div>

<h2>Your Categories: </h2>
<div id="term_div">
        {% for category in categories %}
            <form class="term_add_form" method="POST">
            <br><label class="category_name">{{ category.term }}</label><br>
                
                    <input type="text" class="new_term_box" name="new_term_box">
                    <input type="hidden" class="user_id_term" name="user_id" value="{{ user.id }}">
                    <input type="hidden" class="parent_id" name="parent_id" value="{{ category.id }}">
                    <button class="term_button">Add Search Term</button>
                </form>
                    <div id="cat_term{{ category.id }}">
                        {% for term in terms %}
                            {% if term.parent_id == category.id %}
                                <li>{{ term.term }}</li>
                            {% endif %}
                        {% endfor %}
                    </div>
        {% endfor %}
</div><br><br>


<script type="text/javascript">
    
    // *************** LOGIC FOR CATEGORIES ***************
    function makeCategoryInputElement(categoryName, userId, categoryId){
        // make a string of HTML
        var html = '<form class="term_add_form" method="POST"><br><label class="category_name">' + categoryName + '</label><br><input type="text" class="new_term_box" name="new_term_box"><input type="hidden" class="user_id_term" name="user_id" value=' + userId + '><input type="hidden" class="parent_id" name="parent_id" value=' + categoryId + '><button class="term_button" id="' + categoryId + '">Add Search Term</button></form><div id="cat_term' + categoryId + '"></div>';
        return html;
    }

    function showConfirmation(results) {
        // alert the user their category has been added
        // empty the text area of the form
        // append their new category to the list which displays on their page
        alert(results.message);
        $('#new_category_box').val("");
        var someHtml = makeCategoryInputElement(results.category_name,
                                                results.user_id,
                                                results.category_id);
        $('#term_div').prepend(someHtml);

        if ($('#if_cat-empty')) {
            $('#if_cat-empty').hide()
            $('#snearch_div_hidden').show()
        }
        $('#' + results.category_id).on('click', submitTerm);
    }
    
    function submitCategory(evt) {
        evt.preventDefault();

        var formInputs = {
            "category" : $('#new_category_box').val(),
            "user_id" : $('#user_id_category').val()
        };

        $.post("/add_category",
            formInputs,
            showConfirmation);

        console.dir(evt);
    }

    $('#cat_add_form').on('submit', submitCategory);

    // *************** LOGIC FOR TERMS ***************
    function makeTermInputElement(termName){
        // make a string of HTML
        var html = '<li>' + termName + '</li>';
        return html;
    }

    function showConfirmationTerm(results) {
        // alert the user their term has been added
        // empty the text area of the form
        // append their new term to the list which displays on their page
        alert(results.message);
        var box = $('.new_term_box');
        box.val("");
        var term = results.term_name;
        var termHtml = makeTermInputElement(term);
        var divName = '#cat_term' + results.parent_id
        $(divName).append(termHtml);
    }

    function submitTerm(evt) {
        evt.preventDefault();

        var thingTheyClickedOn = $(evt.currentTarget);
        var listOfInputs = thingTheyClickedOn.siblings();
        var termInput = $(listOfInputs[3]);
        var userInfo = $(listOfInputs[4]);
        var catInfo = $(listOfInputs[5]);

       var formInputs = {
            "term" : termInput.val(),
            "user_id" : userInfo.val(),
            "parent_id" : catInfo.val()
        };

        $.post("/add_term",
            formInputs,
            showConfirmationTerm);

        console.dir(evt);
    }
    
    $('.term_button').on('click', submitTerm);
</script>

{% endblock %}