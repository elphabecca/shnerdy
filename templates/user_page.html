{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" type="text/css" href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">

<script type="text/javascript">$('#user_page_link').hide();</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<br><br>

<div id="user-page" class="container-fluid">
<div class="row row-centered">
    <div id="search-shnerdy" class="col-xs-3 col-centered">
        <br><h4>Search:</h4>
            
            {% if categories == [] %}
                <div id="if_cat-empty">
                    <p>Looks like you haven't created any searches yet. Add some here!</p>
                </div>
            {% endif %}

            {% if categories != [] %}
            <div class="dropdown">
                <form action="/listy" method="POST">
                    <button id="snearch_form" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Your Categories
                    <span class="caret"></span></button>
                    <!-- <input class="span2" id="search_type" name="search_type" type="hidden"> -->
                    <input type="hidden" id="user_id_drop" name="user_id" value="{{ user.id }}">
                        <ul id="drop_cat" class="dropdown-menu">
                        </ul>
                </form>
            </div><br>
            {% endif %}  

            <script type="text/javascript">

                function updateDropdown(results) {
                    $('#drop_cat').empty();
                    var insertHtml = "";
                    var cat_list = results.cat_list;
                    for (i = 0; i < cat_list.length; i++) {
                        var list_item = "'" + cat_list[i] + "'";
                        insertHtml += "<li><input type='submit' class='form-control btn btn-link' name='categories' value=" + list_item + "<a href='#'></a></li>"};
                        // "<li onclick='$('#search_type').val('zip'); $('#searchForm').submit()">Search Zip Code</li>"
                    $('#drop_cat').append(insertHtml);
                }

                function updateDropdownRequest(evt) {
                    var userId = {'user_id' : $('#user_id_drop').val()};

                    $.post("/update_dropdown",
                        userId,
                        updateDropdown);

                    console.dir(evt)
                }

                $('#snearch_form').on('click', updateDropdownRequest);

            </script>

        <hr><br><h4>Add category:</h4>
            <form action='/add_category' id="cat_add_form" method="POST">
                <input type="text" id="new_category_box" name="category">
                <input type="hidden" id="user_id_category" name="user_id" value="{{ user.id }}">
                <input type="submit" class="btn btn-primary" id="category_add" value="Add">
            </form><br><br>
    </div>

    <div id="your-cat" class="col-xs-8 col-centered">
        <div id="cat-title"><h4>Your Categories: </h4></div>

        
        <div class="row" id="term_div">
        {% for category in categories %}
            <div class="col-xs-6 col-md-3">
                <a href="#" class="thumbnail">
                <label class="category_name"><i class="ionicons ion-tshirt"></i>&nbsp;{{ category.term }}</label><br>
                    <ul class='list-unstyled'><div id="cat_term{{ category.id }}">
                        {% for term in terms %}
                            {% if term.parent_id == category.id %}
                                <li>{{ term.term }}</li>
                            {% endif %}
                        {% endfor %}
                    </div></ul>
                <form class="term_add_form" method="POST">
                    <input type="text" class="new_term_box" name="new_term_box">
                    <input type="hidden" class="user_id_term" name="user_id" value="{{ user.id }}">
                    <input type="hidden" class="parent_id" name="parent_id" value="{{ category.id }}">
                    <button class="term_button">Add</button>
                </form>
                </a>
            </div>
        {% endfor %}
        </div> 
    </div>
</div>
</div>


<script type="text/javascript">
    
    // *************** LOGIC FOR CATEGORIES ***************
    function makeCategoryInputElement(categoryName, userId, categoryId){
        // make a string of HTML
        var html = "<div class='col-xs-6 col-md-3'><a href='#' class='thumbnail'><i class='ionicons ion-tshirt'></i><label class='category_name'>&nbsp;" + categoryName + "</label><br><div id='cat_term" + categoryId + "' style='display: inline-block;'></div><form class='term_add_form' method='POST'><input type='text' class='new_term_box' name='new_term_box'><input type='hidden' class='user_id_term' name='user_id' value='" + userId + "'><input type='hidden' class='parent_id' name='parent_id' value='" + categoryId + "'><button class='term_button' id='" + categoryId + "'>Add</button></form></a></div>";
        return html;
    }

    function showConfirmation(results) {
        // empty the text area of the form
        // append their new category to the list which displays on their page
        $('#new_category_box').val("");
        var someHtml = makeCategoryInputElement(results.category_name,
                                                results.user_id,
                                                results.category_id);
        $('#term_div').prepend(someHtml);

        $('#' + results.category_id).on('click', submitTerm);
    }
    
    function submitCategory(evt) {
        evt.preventDefault();

        var formInputs = {
            "category" : $('#new_category_box').val(),
            "user_id" : $('#user_id_category').val()
        };

        $.post("/add_category",
            formInputs,
            showConfirmation);

        console.dir(evt);
    }

    $('#cat_add_form').on('submit', submitCategory);

    // *************** LOGIC FOR TERMS ***************
    function makeTermInputElement(termName){
        // make a string of HTML
        var html = "<li class='list-unstyled'>" + termName + "</li>";
        return html;
    }

    function showConfirmationTerm(results) {
        // empty the text area of the form
        // append their new term to the list which displays on their page
        var box = $('.new_term_box');
        box.val("");
        var term = results.term_name;
        var termHtml = makeTermInputElement(term);
        var divName = '#cat_term' + results.parent_id
        $(divName).append(termHtml);
    }

    function submitTerm(evt) {
        evt.preventDefault();

        var thingTheyClickedOn = $(evt.currentTarget);
        var listOfInputs = thingTheyClickedOn.siblings();
        var termInput = $(listOfInputs[0]);
        var userInfo = $(listOfInputs[1]);
        var catInfo = $(listOfInputs[2]);

       var formInputs = {
            "term" : termInput.val(),
            "user_id" : userInfo.val(),
            "parent_id" : catInfo.val()
        };

        $.post("/add_term",
            formInputs,
            showConfirmationTerm);

        console.dir(evt);
    }
    
    $('.term_button').on('click', submitTerm);

</script>

{% endblock %}


<!-- MASONRY:
https://www.sitepoint.com/bootstrap-tabs-play-nice-with-masonry/
<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>

<div role="tabpanel" class="tab-pane active" id="panel-1">

<div role="tabpanel">

        <ul class="nav nav-tabs" role="tablist" hidden>
            <li role="presentation" class="active">
            <a href="#panel-1" aria-controls="panel-1" role="tab" data-toggle="tab"></a></li>
        </ul>

        <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="panel-1">
        <div class="row masonry-container" id="term_div">

        </div> 
        </div>
        </div>
        </div>

var $container = $('.masonry-container');
    
    $(document).ready( function () {
        $container.masonry({
            columnWidth: '.item',
            itemSelector: '.item'
        });   
    });

    function alignMasonry() {
        $container.masonry({
            columnWidth: '.item',
            itemSelector: '.item'
        });
    }; -->
<!-- '<form class="term_add_form" method="POST"><br><label class="category_name">' + categoryName + '</label><br><input type="text" class="new_term_box" name="new_term_box"><input type="hidden" class="user_id_term" name="user_id" value=' + userId + '><input type="hidden" class="parent_id" name="parent_id" value=' + categoryId + '><button class="term_button" id="' + categoryId + '">Add</button></form><div id="cat_term' + categoryId + '"></div>'; -->